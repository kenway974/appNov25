{% extends 'base.html.twig' %}

{% block title %}Dashboard - {{ user.username }}{% endblock %}

{% block body %}

    <!-- Header avec illustration -->
    <div class="text-center mb-4">
        {% if user.dashboardIllustration %}
            <div class="text-center position-relative d-inline-block">
                {% if user.dashboardIllustration %}
                    <img src="{{ asset('uploads/images/dashboard/' ~ user.dashboardIllustration) }}"
                        alt="{{ user.username }}'s dashboard"
                        class="rounded-circle"
                        style="width: 200px; height: 200px; object-fit: cover;">
                    
                    <span class="position-absolute bottom-0 start-0 translate-middle badge rounded-pill text-bg-secondary"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#dashboardForm"
                        aria-expanded="false"
                        aria-controls="dashboardForm">
                        Modifier
                    </span>
                {% endif %}
            </div>

        {% endif %}
        <h1 class="mt-3">Bienvenue, {{ user.username }} !</h1>

        <!-- Bouton pour afficher le formulaire -->
        <button class="btn btn-outline-light mt-2" 
                type="button" 
                data-bs-toggle="collapse" 
                data-bs-target="#dashboardForm" 
                aria-expanded="false" 
                aria-controls="dashboardForm">
            Changer l'image
        </button>

    <!-- Formulaire Vich en collapse -->
    <div class="collapse mt-3" id="dashboardForm">
        <div class="">
            {{ form_start(form) }}
                {{ form_row(form.dashboardIllustrationFile) }}
                <button type="submit" class="btn btn-outline-light mt-2">Mettre à jour</button>
            {{ form_end(form) }}
        </div>
    </div>
</div>


    <!-- Section Actions -->
    <div class="mt-5">
        <h2 class="text-center mb-4">Actions</h2>
        {% if userActions is not empty %}
            {{ include('user_action/_list.html.twig') }}
        {% else %}
            <p class="text-center text-white">Aucune action trouvée.</p>
        {% endif %}
    </div>

    <!-- Section Besoins -->
    <div class="mb-5 max-mobile-width">
        <h2 class="text-center mb-4">Besoins</h2>
    </div>

    {% if userNeeds is not empty %}
        <div class="mobile-user-needs">
            {{ include('user_need/_list.html.twig') }}
        </div>
    {% else %}
        <p class="text-center text-white mt-4">Aucun besoin trouvé.</p>
    {% endif %}

<!-- Script pour enregistrer le besoin sélectionné -->
<script>
document.querySelectorAll('.user-need-title').forEach(function(el) {
    el.addEventListener('click', function() {
        const id = this.dataset.id;

        fetch('{{ path('set_selected_user_need') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': '{{ csrf_token('set_user_need') }}'
            },
            body: JSON.stringify({ id: id })
        })
        .then(res => res.text())
        .then(data => {
            console.log('ID enregistré en session:', data);
        });
    });
});
</script>
{% endblock %}
